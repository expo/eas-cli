name: system-tests

on:
  workflow_dispatch: {}
  workflow_call: {}

jobs:
  system-tests:
    runs-on: ubuntu-latest
    env:
      EXPO_TOKEN: ${{ secrets.STAGING_EXPO_DEV_EXPO_SERVICES_GITHUB_ROBOT_ACCESS_TOKEN }}
      EXPO_STAGING: "1"
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - uses: volta-cli/action@5c175f92dea6f48441c436471e6479dbc192e194 # v4

      - name: Create test app
        run: npx -y create-expo-app@latest ${{ runner.temp }}/test-app --template tabs

      - name: Link to EAS project
        working-directory: ${{ runner.temp }}/test-app
        run: npx -y eas-cli@latest init --id 6ae8028d-4e6d-4912-8eb2-87d4e6122880 --force --non-interactive

      - name: Add bundle identifiers to app.json
        working-directory: ${{ runner.temp }}/test-app
        run: |
          jq '.expo.ios.bundleIdentifier = "dev.expo.workersystemtests" | .expo.android.package = "dev.expo.workersystemtests"' app.json > app.json.tmp
          mv app.json.tmp app.json

      - name: Configure EAS Build
        working-directory: ${{ runner.temp }}/test-app
        run: npx -y eas-cli@latest build:configure --platform all

      - name: Add system-test profile to eas.json
        working-directory: ${{ runner.temp }}/test-app
        run: |
          jq '.build["system-test"] = { "ios": { "simulator": true }, "android": { "withoutCredentials": true } }' eas.json > eas.json.tmp
          mv eas.json.tmp eas.json

      - name: Setup EAS workflow
        working-directory: ${{ runner.temp }}/test-app
        run: |
          mkdir -p .eas/workflows
          cp ${{ github.workspace }}/.github/fixtures/eas-workflow-build-android.yml .eas/workflows/build-android.yml

      - name: Run iOS build and Android workflow concurrently
        working-directory: ${{ runner.temp }}/test-app
        run: |
          set -euo pipefail

          BUILD_JSON=$(npx -y eas-cli@latest build --platform ios --profile system-test --non-interactive --no-wait --json)
          BUILD_ID=$(echo "$BUILD_JSON" | jq -r 'if type=="array" then .[0].id // .[0].build.id // .[0].buildId else .id // .build.id // .buildId end // empty')
          if [ -z "$BUILD_ID" ]; then
            echo "Error: could not determine build ID"
            echo "$BUILD_JSON" | jq .
            exit 1
          fi
          echo "BUILD_ID=$BUILD_ID" >> "$GITHUB_ENV"
          echo "Resolved BUILD_ID=$BUILD_ID"

          WORKFLOW_JSON=$(npx -y eas-cli@latest workflow:run build-android.yml --non-interactive --no-wait --json)
          WORKFLOW_RUN_ID=$(echo "$WORKFLOW_JSON" | jq -r '.id // .workflowRun.id // .workflowRunId // empty')
          if [ -z "$WORKFLOW_RUN_ID" ]; then
            echo "Error: could not determine workflow run ID"
            echo "$WORKFLOW_JSON" | jq .
            exit 1
          fi
          echo "WORKFLOW_RUN_ID=$WORKFLOW_RUN_ID" >> "$GITHUB_ENV"
          echo "Resolved WORKFLOW_RUN_ID=$WORKFLOW_RUN_ID"

          is_terminal_build_status() {
            case "$1" in
              FINISHED|ERRORED|CANCELED) return 0 ;;
              *) return 1 ;;
            esac
          }

          is_terminal_workflow_status() {
            case "$1" in
              SUCCESS|FAILURE|CANCELED|ACTION_REQUIRED) return 0 ;;
              *) return 1 ;;
            esac
          }

          BUILD_STATUS=""
          WORKFLOW_STATUS=""

          while true; do
            BUILD_STATUS=$(npx -y eas-cli@latest build:view "$BUILD_ID" --non-interactive --json | jq -r '.status // empty')
            WORKFLOW_STATUS=$(npx -y eas-cli@latest workflow:view "$WORKFLOW_RUN_ID" --non-interactive --json | jq -r '.status // empty')

            echo "iOS build status: $BUILD_STATUS"
            echo "Android workflow status: $WORKFLOW_STATUS"

            if is_terminal_build_status "$BUILD_STATUS" && is_terminal_workflow_status "$WORKFLOW_STATUS"; then
              break
            fi

            sleep 7
          done

          EXIT_CODE=0

          if [ "$BUILD_STATUS" != "FINISHED" ]; then
            echo "Build did not finish successfully: $BUILD_STATUS"
            EXIT_CODE=1
          fi

          if [ "$WORKFLOW_STATUS" != "SUCCESS" ]; then
            echo "Workflow did not finish successfully: $WORKFLOW_STATUS"
            EXIT_CODE=1
          fi

          exit "$EXIT_CODE"

      - name: Cancel EAS runs on workflow cancellation
        if: always() && (cancelled() || failure())
        run: |
          set -euo pipefail

          if [ -n "${BUILD_ID:-}" ]; then
            echo "Canceling EAS build: $BUILD_ID"
            npx -y eas-cli@latest build:cancel "$BUILD_ID" --non-interactive || true
          fi
          if [ -n "${WORKFLOW_RUN_ID:-}" ]; then
            echo "Canceling EAS workflow run: $WORKFLOW_RUN_ID"
            npx -y eas-cli@latest workflow:cancel "$WORKFLOW_RUN_ID" --non-interactive || true
          fi
